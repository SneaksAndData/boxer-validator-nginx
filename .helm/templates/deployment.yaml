apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "app.name" . }}
  labels:
    {{- include "app.labels" $ | nindent 4 }}
  {{- with .Values.additionalAnnotations }}
  annotations:
    {{ toYaml . | nindent 4 }}
  {{- end }}
spec:
  selector:
    matchLabels:
      {{- include "app.selectorLabels" $ | nindent 6 }}
  replicas: {{ .Values.validator.replicas | default 1 }}
  # The deployment strategy is hardcoded as well until NCC supports HA mode
  strategy:
    type: {{ .Values.validator.deploymentStrategy.type | default 1 }}
  template:
    metadata:
      labels:
        {{- include "app.labels" $ | nindent 8 }}
      annotations:
        deployment/date: {{ now }} # Force redeployment
      {{- with .Values.additionalAnnotations }}
        {{ toYaml . | nindent 8 }}
      {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{ toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "app.serviceAccountName" . }}
      {{- with .Values.securityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if and .Values.openTelemetry.enabled .Values.openTelemetry.waitForCollector.enabled }}
      initContainers:
        - name: wait-for-telemetry
          image: "{{ include "app.image" . }}"
          imagePullPolicy: "{{ .Values.image.pullPolicy }}"
          env:
            - name: OTEL_EXPORTER_HOST
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          command:
            - 'sh'
            - '-c'
            - 'until nc -z ${OTEL_EXPORTER_HOST} 4317; do echo waiting for OpenTelemetry Collector; sleep 2; done;'
      {{- end }}
      containers:
        - name: boxer-validator
          ports:
            - containerPort: {{ .Values.validator.config.port }}
              name: http
              protocol: TCP
        {{- with .Values.securityContext }}
          securityContext:
        {{ toYaml . | nindent 12 }}
        {{- end }}
          image: "{{ include "app.image" . }}"
          imagePullPolicy: "{{ .Values.image.pullPolicy }}"
          {{- if .Values.validator.config.enabled }}
          envFrom:
            - secretRef:
                name: {{ include "app.fullname" . }}-token-settings
                optional: false
          {{- end }}
          env:
            - name: APPLICATION_VERSION
              value: "{{ (default (printf "v%s" .Chart.AppVersion) .Values.image.tag) }}"
          {{- if .Values.validator.config.enabled }}
            - name: RUST_LOG
              value: {{ .Values.validator.config.logLevel | default "info" | quote }}
            - name: BOXER_VALIDATOR__DEPLOY_ENVIRONMENT
              value: {{ .Values.environment | default "development" | lower }}
            - name: BOXER_VALIDATOR__INSTANCE_NAME
              value: {{ .Values.validator.config.instance_name | default .Release.Name | lower }}
            - name: BOXER_VALIDATOR__LISTEN_ADDRESS
              value: "{{ (default "127.0.0.1" .Values.validator.config.listenIp) }}:{{ .Values.validator.config.port }}"
            - name: BOXER_VALIDATOR__BACKEND__KUBERNETES__EXEC
              value: {{ .Values.validator.config.backend.kubernetes.kubeconfig.exec | quote }}
            - name: BOXER_VALIDATOR__BACKEND__KUBERNETES__KUBECONFIG
              value: {{ .Values.validator.config.backend.kubernetes.kubeconfig.filePath | quote }}
            - name: BOXER_VALIDATOR__BACKEND__KUBERNETES__IN_CLUSTER
              value: {{ .Values.validator.config.backend.kubernetes.kubeconfig.inCluster | quote }}
            - name: BOXER_VALIDATOR__BACKEND__KUBERNETES__NAMESPACE
              value: "{{ (default .Release.Namespace .Values.validator.config.backend.kubernetes.namespace) }}"
            - name: BOXER_VALIDATOR__BACKEND__KUBERNETES__OPERATION_TIMEOUT
              value: {{ (default .Release.Namespace .Values.validator.config.backend.kubernetes.operationTimeout) | quote }}
            - name: BOXER_VALIDATOR__BACKEND__KUBERNETES__RESOURCE_OWNER_LABEL
              value: {{ (default "boxer.sneaksanddata.com/owner" .Values.validator.config.backend.kubernetes.resourceOwnerLabel) | quote }}
            - name: BOXER_VALIDATOR__TOKEN_SETTINGS__AUDIENCE
              value: {{ .Values.validator.config.tokenSettings.audience | default "boxer.sneaksanddata.com" }}
            - name: BOXER_VALIDATOR__TOKEN_SETTINGS__ISSUER
              value: {{ .Values.validator.config.tokenSettings.issuer | default "boxer.sneaksanddata.com" }}
          {{- end }}
          {{- if .Values.openTelemetry.enabled }}
            {{- if .Values.openTelemetry.grpcEndpoint }}
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: {{ .Values.openTelemetry.grpcEndpoint | quote }}
            {{else}}
            - name: OTEL_EXPORTER_HOST
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: "http://$(OTEL_EXPORTER_HOST):4317"
            {{- end }}
            - name: OTEL_SERVICE_NAME
              value: {{ (default (include "app.name" .) .Values.openTelemetry.serviceName) | quote }}
            - name: BOXER_VALIDATOR__OPENTELEMETRY__LOG_SETTINGS__ENABLED
              value: {{ .Values.openTelemetry.logs.enabled | default "false" | quote }}
            - name: BOXER_VALIDATOR__OPENTELEMETRY__METRICS_SETTINGS__ENABLED
              value: {{ .Values.openTelemetry.logs.enabled | default "false" | quote }}
            - name: BOXER_VALIDATOR__OPENTELEMETRY__TRACING_SETTINGS__ENABLED
              value: {{ .Values.openTelemetry.logs.enabled | default "false" | quote }}
          {{- end }}
        {{- with .Values.extraEnv }}
          {{ toYaml . | nindent 12 }}
        {{- end }}
        {{- with .Values.extraEnvFrom }}
          {{ toYaml . | nindent 12 }}
        {{- end }}
        {{- with .Values.extraVolumeMounts }}
          {{ toYaml . | nindent 12 }}
        {{- end }}
        {{- with .Values.resources }}
          resources:
          {{- toYaml . | nindent 12 }}
        {{- end }}
      {{- if .Values.extraVolumes }}
      volumes:
        {{- with .Values.extraVolumes }}
          {{ toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{ toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{ toYaml . | nindent 8 }}
      {{- end }}